name: Supabase Secure SQL Runner

on:
  workflow_dispatch:

jobs:
  run-sql-safely:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Run secret SQL securely
        env:
          DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          FUNCTION_YOU_CANT_ACCESS: ${{ secrets.FUNCTION_YOU_CANT_ACCESS }}
          FUNCTION_CLEANING: ${{ secrets.FUNCTION_CLEANING }}
          FUNCTION_SY_TOPICS: ${{ secrets.FUNCTION_SY_TOPICS }}

        run: |
          echo "ðŸ” Debug: Contenido de FUNCTION_YOU_CANT_ACCESS:"
          echo "$FUNCTION_YOU_CANT_ACCESS"
          echo "---"
          
          echo "$FUNCTION_YOU_CANT_ACCESS" > .temp_query.sql
          echo "ðŸ“¡ Ejecutando consulta secreta..."
          psql "$DB_URL" -f .temp_query.sql
          
          echo "$FUNCTION_CLEANING" > .temp_cleaning.sql
          echo "ðŸ§¹ Ejecutando limpieza..."
          psql "$DB_URL" -f .temp_cleaning.sql
          
          echo "$FUNCTION_YOU_CANT_ACCESS" > .temp_query.sql
          echo "ðŸ“¡ Ejecutando consulta secreta..."
          psql "$DB_URL" -f .temp_query.sql
          
          echo "$FUNCTION_SY_TOPICS" > .temp_sync_topics.sql
          echo "ðŸ”„ Ejecutando funciÃ³n SY_TOPICS..."
          psql "$DB_URL" -f .temp_sync_topics.sql
